<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>'‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á'‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô V6 (Hybrid-GitHub)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f9; color: #334155; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        .config-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border-left: 4px solid #3b82f6; transition: all 0.2s ease-in-out; }
        .config-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07); }
        .circuit-container { background-color: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; border: 1px solid #e2e8f0; }
        .form-input { border-radius: 0.5rem; border-color: #cbd5e1; transition: all 0.2s ease-in-out; width: 100%; padding: 0.5rem; border: 1px solid #ccc; }
        .form-input:focus { outline: none; border-color: #3b82f6; ring: 2px; ring-color: #3b82f6; }
        .btn { border-radius: 0.5rem; font-weight: 700; padding: 0.75rem 1rem; cursor: pointer; }
        .btn-primary { background-image: linear-gradient(to right, #3b82f6, #2563eb); color: white; }
        .btn-secondary { background-color: #475569; color: white; }
        .btn-delete-row { background-color: #fee2e2; color: #ef4444; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }
        
        /* Status Badge */
        .status-badge { position: fixed; top: 10px; right: 10px; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status-offline { background-color: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .status-online { background-color: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .status-loading { background-color: #e0f2fe; color: #0369a1; border: 1px solid #38bdf8; }

        /* Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Accordion */
        .collapsible-card > *:not(h3) { display: none; }
        .collapsible-card.open > * { display: block; }
        .collapsible-card h3 { cursor: pointer; }
        .collapsible-card h3::after { content: "‚ñ∂"; float: right; transition: transform .2s; }
        .collapsible-card.open h3::after { content: "‚ñº"; transform: rotate(90deg); }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; }
            .no-print, .status-badge { display: none; }
        }
    </style>
</head>
<body class="antialiased">

<!-- Status Indicator -->
<div id="system-status" class="status-badge status-loading">
    ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
</div>

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-10 no-print">
        <h1 class="text-5xl font-bold text-blue-600 tracking-tight">'‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á'‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô <span class="text-3xl text-amber-500">Hybrid-GitHub</span></h1>
        <p class="text-xl text-slate-500 mt-2">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏¢‡∏∏‡∏Ñ‡πÉ‡∏´‡∏°‡πà (‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å GitHub)</p>
    </header>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ -->
    <div class="mb-6 no-print">
        <div class="config-card">
            <h2 class="text-2xl font-bold text-blue-600 border-b-2 border-slate-200 pb-2 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label class="block text-sm font-medium text-slate-600">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label><input class="form-input mt-1" id="project_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢" type="text"/></div>
                <div><label class="block text-sm font-medium text-slate-600">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input class="form-input mt-1" id="customer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" type="text"/></div>
                <div><label class="block text-sm font-medium text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input class="form-input mt-1" id="report_date" type="date"/></div>
            </div>
        </div>
    </div>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- ‡∏™‡πà‡∏ß‡∏ô Input (‡∏ã‡πâ‡∏≤‡∏¢) -->
        <div class="lg:col-span-2 space-y-6" id="task-inputs-container">
             
             <!-- ‡πÄ‡∏°‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
             <div class="config-card collapsible-card">
                <h3 class="text-xl font-bold mb-4 text-slate-700 flex items-center gap-3">
                    <span>‚ö° ‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</span>
                </h3>
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg bg-blue-50 space-y-4">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-slate-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏™‡∏≤</label><select class="form-input" id="pole_height_7"><option value="0">-- ‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å‡πÄ‡∏™‡∏≤ --</option><option value="6.0">6.0 ‡πÄ‡∏°‡∏ï‡∏£</option><option value="7.0">7.0 ‡πÄ‡∏°‡∏ï‡∏£</option><option value="8.0">8.0 ‡πÄ‡∏°‡∏ï‡∏£</option><option value="9.0">9.0 ‡πÄ‡∏°‡∏ï‡∏£</option></select></div>
                            <div><label class="text-sm font-medium text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏™‡∏≤ (‡∏ï‡πâ‡∏ô)</label><input class="form-input" id="pole_count_7" type="number" placeholder="0"/></div>
                            <div><label class="text-sm font-medium text-slate-600">‡πÅ‡∏£‡πá‡∏Ñ 2 ‡∏ä‡∏∏‡∏î (‡∏ï‡πâ‡∏ô)</label><input class="form-input" id="rack_2_sets_7" type="number" placeholder="0"/></div>
                            <div><label class="text-sm font-medium text-slate-600">‡πÅ‡∏£‡πá‡∏Ñ 4 ‡∏ä‡∏∏‡∏î (‡∏ï‡πâ‡∏ô)</label><input class="form-input" id="rack_4_sets_7" type="number" placeholder="0"/></div>
                         </div>
                    </div>
                    <div class="p-4 border rounded-lg bg-blue-50 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-slate-600">‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label><select class="form-input" id="main_authority_7"><option value="MEA">‡∏Å‡∏ü‡∏ô.</option><option value="PEA">‡∏Å‡∏ü‡∏†.</option></select></div>
                            <div><label class="text-sm font-medium text-slate-600">‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</label><select class="form-input" id="meter_size_3"><option value="5(15)">5(15)A</option><option selected value="15(45)">15(45)A</option><option value="30(100)">30(100)A</option></select></div>
                            <div><label class="text-sm font-medium text-slate-600">‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏≤‡∏¢</label><select class="form-input" id="main_ext_type_7"><option value="THW">‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á (THW)</option><option value="THW-A">‡∏≠‡∏∞‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (THW-A)</option></select></div>
                            <div><label class="text-sm font-medium text-slate-600">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£)</label><input class="form-input" id="main_ext_dist_7" type="number" placeholder="0"/></div>
                            <div class="md:col-span-2"><p class="p-3 bg-blue-100 text-blue-800 rounded text-center font-mono" id="main_cable_spec_display">‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p></div>
                        </div>
                    </div>
                </div>
             </div>

             <!-- ‡∏ï‡∏π‡πâ‡∏Ñ‡∏≠‡∏ô‡∏ã‡∏π‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå -->
             <div class="config-card collapsible-card">
                <h3 class="text-xl font-bold mb-4 text-slate-700 flex items-center gap-3">
                    <span>üîå ‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="text-sm font-medium text-slate-600">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏π‡πâ CU</label><select class="form-input" id="cu_replacement"><option value="none">-- ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô --</option><option value="4_slot">4 ‡∏ä‡πà‡∏≠‡∏á</option><option value="6_slot">6 ‡∏ä‡πà‡∏≠‡∏á</option><option value="8_slot">8 ‡∏ä‡πà‡∏≠‡∏á</option><option value="10_slot">10 ‡∏ä‡πà‡∏≠‡∏á</option><option value="12_slot">12 ‡∏ä‡πà‡∏≠‡∏á</option></select></div>
                    <div><label class="flex items-center mt-6"><input class="mr-2" id="install_ground" type="checkbox"/> ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</label></div>
                    <div><label class="text-sm font-medium text-slate-600">‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏≤‡∏¢‡∏î‡∏¥‡∏ô (‡∏°.)</label><input class="form-input" id="ground_distance" type="number" placeholder="0"/></div>
                </div>
                <div class="mt-4 border-t pt-4">
                    <h4 class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏¢‡πà‡∏≠‡∏¢</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="text-xs text-slate-500">16A</label><input class="form-input" id="mcb_16a" type="number" placeholder="0"/></div>
                        <div><label class="text-xs text-slate-500">20A</label><input class="form-input" id="mcb_20a" type="number" placeholder="0"/></div>
                        <div><label class="text-xs text-slate-500">32A</label><input class="form-input" id="mcb_32a" type="number" placeholder="0"/></div>
                    </div>
                </div>
             </div>

             <!-- ‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á/‡πÄ‡∏ï‡πâ‡∏≤‡∏£‡∏±‡∏ö -->
             <div class="config-card collapsible-card"><h3 class="text-xl font-bold mb-4 text-slate-700">üí° ‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á/‡πÄ‡∏ï‡πâ‡∏≤‡∏£‡∏±‡∏ö</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏á‡∏à‡∏£‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á</label><input class="form-input" id="light_circuits" type="number"/></div>
                        <div><label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label><select class="form-input" id="light_type"><option value="surface_pvc">‡∏ó‡πà‡∏≠ PVC ‡∏•‡∏≠‡∏¢</option><option value="concealed_pvc">‡∏ó‡πà‡∏≠ PVC ‡∏ù‡∏±‡∏á</option></select></div>
                        <div class="col-span-2"><label>‡πÇ‡∏Ñ‡∏°‡πÑ‡∏ü</label><select class="form-input" id="fixture_type_1"><option value="LED_E27">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÑ‡∏•‡∏ó‡πå E27</option><option value="LED_PANEL">LED Panel</option></select></div>
                    </div>
                    <div id="light_circuits_container" class="space-y-2"></div>
                    <div class="grid grid-cols-2 gap-4 border-t pt-4">
                        <div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏á‡∏à‡∏£‡πÄ‡∏ï‡πâ‡∏≤‡∏£‡∏±‡∏ö</label><input class="form-input" id="socket_circuits" type="number"/></div>
                        <div><label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label><select class="form-input" id="socket_type"><option value="surface_pvc">‡∏ó‡πà‡∏≠ PVC ‡∏•‡∏≠‡∏¢</option><option value="surface_vaf">‡∏ï‡∏µ‡∏Å‡∏¥‡πä‡∏õ VAF</option></select></div>
                    </div>
                    <div id="socket_circuits_container" class="space-y-2"></div>
                </div>
             </div>

             <!-- ‡πÅ‡∏≠‡∏£‡πå/‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô -->
             <div class="config-card collapsible-card"><h3 class="text-xl font-bold mb-4 text-slate-700">‚ùÑÔ∏è ‡πÅ‡∏≠‡∏£‡πå/‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>‡πÅ‡∏≠‡∏£‡πå (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label><input class="form-input" id="ac_units" type="number"/></div>
                    <div><label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label><select class="form-input" id="ac_install_type_4"><option value="surface_pvc">‡∏ó‡πà‡∏≠ PVC ‡∏•‡∏≠‡∏¢</option></select></div>
                    <div><label>‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏≠‡∏£‡πå (‡∏°./‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label><input class="form-input" id="ac_distance" type="number" value="15"/></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4">
                    <div><label>‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label><input class="form-input" id="heater_units" type="number"/></div>
                    <div><label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label><select class="form-input" id="wh_install_type_5"><option value="surface_pvc">‡∏ó‡πà‡∏≠ PVC ‡∏•‡∏≠‡∏¢</option></select></div>
                    <div><label>‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô (‡∏°./‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label><input class="form-input" id="heater_distance" type="number" value="15"/></div>
                    <div><label><input type="checkbox" id="heater_exclude_hoses"/> ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏î‡∏µ</label></div>
                </div>
             </div>

             <!-- ‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/EV/‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô -->
             <div class="config-card collapsible-card"><h3 class="text-xl font-bold mb-4 text-slate-700">üõ†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/EV/‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô</h3>
                 <div class="space-y-4">
                     <!-- EV -->
                     <div class="p-3 bg-blue-50 rounded border">
                         <h4 class="font-bold text-sm mb-2">EV Charger</h4>
                         <label><input type="checkbox" id="toggle_ev_charger_visibility"> ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á EV Charger</label>
                         <div id="ev_charger_content_wrapper" class="hidden mt-2">
                             <input type="number" id="ev_cable_dist_8" class="form-input mb-2" placeholder="‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏≤‡∏¢ (‡∏°.)">
                             <input type="number" id="ev_charger_cost_8" class="form-input" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ö‡∏≤‡∏ó)">
                             <select id="ev_install_type_8" class="form-input mt-2"><option value="existing_meter">‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°</option><option value="new_meter_tou">‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå TOU ‡πÉ‡∏´‡∏°‡πà</option></select>
                         </div>
                     </div>
                     <!-- ‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô -->
                     <div class="p-3 bg-red-50 rounded border">
                         <h4 class="font-bold text-sm mb-2">‡∏á‡∏≤‡∏ô‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô</h4>
                         <div class="grid grid-cols-2 gap-2">
                             <input type="number" id="demo_lights_9" class="form-input" placeholder="‡∏£‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡∏° (‡∏à‡∏∏‡∏î)">
                             <input type="number" id="demo_outlets_9" class="form-input" placeholder="‡∏£‡∏∑‡πâ‡∏≠‡∏õ‡∏•‡∏±‡πä‡∏Å (‡∏à‡∏∏‡∏î)">
                             <input type="number" id="demo_cables_9" class="form-input" placeholder="‡∏£‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏¢ (‡∏°.)">
                             <input type="number" id="demo_ac_9" class="form-input" placeholder="‡∏£‡∏∑‡πâ‡∏≠‡πÅ‡∏≠‡∏£‡πå (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)">
                         </div>
                         <label class="mt-2 block text-xs"><input type="checkbox" id="demo_include_repair_9"> ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏ú‡∏ô‡∏±‡∏á</label>
                     </div>
                     <!-- Service -->
                     <div class="p-3 bg-yellow-50 rounded border">
                         <h4 class="font-bold text-sm mb-2">Service</h4>
                         <label class="block"><input type="checkbox" id="service_inspection"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö</label>
                         <label class="block"><input type="checkbox" id="service_leak_find"> ‡∏´‡∏≤‡πÑ‡∏ü‡∏£‡∏±‡πà‡∏ß</label>
                         <label class="block"><input type="checkbox" id="service_trip_find"> ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏£‡∏¥‡∏õ</label>
                         <input type="number" id="service_lamp_replace" class="form-input mt-2" placeholder="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏•‡∏≠‡∏î (‡∏à‡∏∏‡∏î)">
                     </div>
                 </div>
             </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏Ç‡∏ß‡∏≤) -->
        <div class="lg:col-span-1 space-y-6">
            <div class="sticky top-4">
                <section class="bg-white p-6 rounded-lg shadow-lg mb-6">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-600">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
                    <div class="space-y-3">
                        <div><label class="text-sm">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><select class="form-input" id="province_selector"></select></div>
                        <div id="bkk_zone_container" class="hidden"><label class="text-sm">‡πÇ‡∏ã‡∏ô ‡∏Å‡∏ó‡∏°.</label><select class="form-input" id="bkk_zone_selector"><option value="BKK_Zone5_Suburban">‡∏ä‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option><option value="BKK_Zone1_CBD">‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option></select></div>
                        <div><label class="text-sm">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏™‡∏î‡∏∏</label><select class="form-input" id="material_quality"><option value="1.0">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</option><option value="1.4">‡πÄ‡∏Å‡∏£‡∏î‡∏î‡∏µ</option></select></div>
                        <div class="flex items-center gap-2"><input type="checkbox" id="include_vat"/><label class="text-sm">‡∏Ñ‡∏¥‡∏î VAT 7%</label></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-xs">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ %</label><input class="form-input" id="overhead_factor" type="number" value="0"/></div>
                            <div><label class="text-xs">‡∏Å‡∏≥‡πÑ‡∏£ %</label><input class="form-input" id="profit_factor" type="number" value="0"/></div>
                        </div>
                        <div><label class="text-xs">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label><input class="form-input" id="min_charge" type="number" value="1000"/></div>
                        <div><label class="text-xs">‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏ %</label><input class="form-input" id="wastage_factor" type="number" value="0"/></div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-xl text-center">
                    <p class="text-lg text-slate-500" id="total-display-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <p class="text-5xl font-bold text-blue-600 my-2" id="total-display">‡∏ø0.00</p>
                    <button class="btn btn-primary w-full mt-4 text-lg" id="calculate-btn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
                    <button class="btn btn-secondary w-full mt-2" id="reset-btn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </section>
                
                <!-- Price Editor -->
                <section class="bg-white p-4 rounded-lg shadow mt-6 max-h-60 overflow-y-auto">
                    <h3 class="font-bold mb-2 text-sm">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</h3>
                    <table class="w-full text-xs">
                        <tbody id="price-editor-body"></tbody>
                    </table>
                </section>
            </div>
        </div>
    </main>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Report -->
    <section class="mt-12 bg-white p-6 rounded-lg shadow-lg hidden" id="output-section">
        <div class="flex justify-between items-center border-b pb-2 mb-4 no-print">
            <h2 class="text-2xl font-bold text-blue-600">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
            <div class="flex gap-2">
                <button id="print-btn" class="btn btn-secondary text-sm">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                <button id="save-pdf-btn" class="btn btn-primary text-sm bg-red-600">PDF</button>
            </div>
        </div>
        
        <!-- Manual Item Adder -->
        <div class="no-print p-4 bg-gray-50 rounded mb-4 border">
             <h4 class="font-bold text-sm mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏© (Manual)</h4>
             <div class="grid grid-cols-4 gap-2">
                 <div class="col-span-2"><input type="text" id="manual-job-name" class="form-input text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô"></div>
                 <div><input type="number" id="manual-job-labor-total" class="form-input text-sm" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤"></div>
                 <div><button id="manual-job-add-btn" class="btn btn-primary text-sm w-full">+</button></div>
             </div>
             <input type="hidden" id="manual-job-qty" value="1"><input type="hidden" id="manual-job-unit" value="‡∏á‡∏≤‡∏ô">
             <table id="manual-job-materials-table" class="hidden"><tbody></tbody></table>
             <button id="manual-job-add-material-row" class="hidden"></button>
        </div>

        <!-- Tabs -->
        <div class="no-print border-b mb-4">
            <nav class="flex space-x-4">
                <button class="tab-btn tab-active py-2 font-bold" data-tab="boq-combined">BOQ ‡∏£‡∏ß‡∏°</button>
                <button class="tab-btn py-2 text-gray-500" data-tab="purchase-order">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </nav>
        </div>
        <div id="report-content"></div>
    </section>

    <div id="print-area" class="hidden"></div>
</div>

<script>
    // ==========================================
    // 1. REMOTE DATA LOADER
    // ==========================================
    
    // ‡∏•‡∏¥‡∏á‡∏Å‡πå Raw ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå data.json
    const GITHUB_DATA_URL = "https://raw.githubusercontent.com/tanthaitanium21-dot/appp/refs/heads/main/data.json";

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let appData = {}; 
    let priceList = {};
    let initialPriceList = {};
    let electricalData = [];
    
    const allTasks = new Map();
    const allItems = new Map();
    let manualBOQItems = [];
    let manualPOItems = [];

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    async function loadData() {
        const statusBadge = document.getElementById('system-status');
        
        try {
            statusBadge.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å GitHub...';
            
            const response = await fetch(GITHUB_DATA_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            appData = data;
            priceList = data.priceList;
            initialPriceList = JSON.parse(JSON.stringify(data.priceList));
            electricalData = data.electrical_installation_data;
            
            // Map Data
            if (electricalData) {
                electricalData.forEach(c => {
                    c.tasks.forEach(t => {
                        allTasks.set(t.task_id, t);
                        t.labor_components?.forEach(l => allItems.set(l.labor_id, { desc: `‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á: ${t.task_name}`}));
                        t.material_components?.forEach(m => allItems.set(m.material_id, { desc: m.spec }));
                    });
                });
            }
            
            statusBadge.className = 'status-badge status-online';
            statusBadge.innerHTML = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GitHub ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            
            renderUI();
            
        } catch (error) {
            console.error("Failed to load data:", error);
            statusBadge.className = 'status-badge status-offline';
            statusBadge.innerHTML = `üî¥ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`;
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå GitHub\n" + error.message);
        }
    }

    function renderUI() {
        // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        const select = document.getElementById('province_selector');
        select.innerHTML = '';
        if(appData.provinces) {
            appData.provinces.forEach(p => {
                select.add(new Option(p, p));
            });
        }
        select.value = '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ';

        // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
        const tbody = document.getElementById('price-editor-body');
        let html = '';
        if (priceList) {
            for (const [key, price] of Object.entries(priceList)) {
                const desc = allItems.get(key)?.desc || key;
                html += `<tr class="border-b"><td class="p-2 text-slate-600">${key}<br><small class="text-gray-400">${desc}</small></td><td class="p-2 text-right"><input type="number" class="w-20 text-right border rounded bg-gray-50 px-1" value="${price}" onchange="updatePrice('${key}', this.value)"></td></tr>`;
            }
        }
        tbody.innerHTML = html;
        
        resetForm();
    }
    
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset Form ---
    function resetForm() {
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ Input
        document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
            if (!input.id.includes('overhead') && !input.id.includes('profit') && !input.id.includes('min_charge') && !input.id.includes('wastage')) {
                 if (input.id.includes('_distance') || input.id.includes('units') || input.id.includes('points') || input.id.includes('circuits') || input.id.includes('pole_') || input.id.includes('rack_')) {
                   input.value = '';
                }
            }
        });

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ Manual Item
        const manualName = document.getElementById('manual-job-name');
        if(manualName) manualName.value = '';
        const manualLabor = document.getElementById('manual-job-labor-total');
        if(manualLabor) manualLabor.value = '';
        
        try {
            const tbody = document.querySelector('#manual-job-materials-table tbody');
            if(tbody) tbody.innerHTML = '';
            const qty = document.getElementById('manual-job-qty');
            if(qty) qty.value = '1';
        } catch(e) {}

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        manualBOQItems = [];
        manualPOItems = [];
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (initialPriceList && priceList) {
            Object.assign(priceList, JSON.parse(JSON.stringify(initialPriceList)));
            const tbody = document.getElementById('price-editor-body');
            if (tbody) {
                let html = '';
                for (const [key, price] of Object.entries(priceList)) {
                    const desc = allItems.get(key)?.desc || key;
                    html += `<tr class="border-b"><td class="p-2 text-slate-600">${key}<br><small class="text-gray-400">${desc}</small></td><td class="p-2 text-right"><input type="number" class="w-20 text-right border rounded bg-gray-50 px-1" value="${price}" onchange="updatePrice('${key}', this.value)"></td></tr>`;
                }
                tbody.innerHTML = html;
            }
        }
        
        if (typeof updateRealtimeTotal === 'function') {
            updateRealtimeTotal();
        }
    }

    // ==========================================
    // 2. CALCULATION LOGIC
    // ==========================================
    
    function formatCurrency(num) {
        return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function getMaterialQuantity(material, taskQuantity) {
        const logic = material.usage_logic;
        if (taskQuantity <= 0) return 0;
        if (!logic) return taskQuantity;

        let qty = 0;
        if (logic.includes('per meter')) {
            const factor = parseFloat(logic.split(' ')[0]);
            qty = taskQuantity * factor;
        } else if (logic.includes('per unit')) {
             const factor = parseFloat(logic.split(' ')[0]);
            qty = taskQuantity * factor;
        } else if (logic.includes('ceil(m/2.92)')) {
            qty = Math.ceil(taskQuantity / 2.92);
        } else if (logic.includes('ceil(m/3.05)')) {
            qty = Math.ceil(taskQuantity / 3.05);
        } else {
            qty = taskQuantity;
        }
        return Math.ceil(qty);
    }
    
    function createSummaryTable(summaryItems) {
        let rows = summaryItems.map(item => `
            <tr>
                <td class="px-6 py-2 text-right font-semibold text-slate-700 ${item.isTotal ? 'text-base' : ''}">${item.label}</td>
                <td class="px-6 py-2 text-right font-bold w-1/3 ${item.isTotal ? 'text-lg text-red-600' : ''}">${formatCurrency(item.value)}</td>
            </tr>
        `).join('');
        return `<div class="mt-8 flex justify-end"><table class="w-full md:w-2/3 lg:w-1/2 text-sm">${rows}</table></div>`;
    }

    window.updatePrice = function(key, val) {
        if(priceList) priceList[key] = parseFloat(val) || 0;
        if (typeof updateRealtimeTotal === 'function') updateRealtimeTotal();
    };
    
    function updateMainCableSpecDisplay() {
        const province = document.getElementById('province_selector').value;
        const authorityEl = document.getElementById('main_authority_7');
        const cableTypeEl = document.getElementById('main_ext_type_7');
        const meterSize = document.getElementById('meter_size_3').value;
        const displayEl = document.getElementById('main_cable_spec_display');

        let authority = 'PEA';
        if (appData.provinceZones && appData.provinceZones.MEA.includes(province)) {
            authority = 'MEA';
        }
        if(authorityEl) authorityEl.value = authority;

        const cableType = cableTypeEl ? cableTypeEl.value : 'THW';
        let cableSpecText = "N/A";
        
        try {
            const spec = appData.mainCableSpecs_v5_1[authority][meterSize];
            if (spec && spec[cableType]) {
                cableSpecText = `${cableType} ${spec[cableType]} mm¬≤`;
            } else if (cableType === 'THW-A' && authority === 'MEA') {
                cableSpecText = "‡∏Å‡∏ü‡∏ô. ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö THW-A";
            }
        } catch (e) {}

        if(displayEl) displayEl.textContent = cableSpecText;
    }

    function buildTaskQuantitiesFromConfig() {
        const quantities = new Map();
        const addQty = (id, val) => quantities.set(id, (quantities.get(id) || 0) + val);

        ['socket', 'light'].forEach(prefix => {
            const circuitCount = parseInt(document.getElementById(`${prefix}_circuits`).value) || 0;
            if (circuitCount === 0) return;
            const installType = document.getElementById(`${prefix}_type`).value;
            
            for (let i = 1; i <= circuitCount; i++) {
                const panelDist = parseFloat(document.getElementById(`${prefix}_circuit_${i}_panel_dist`)?.value) || 0;
                const pointsInCircuit = parseInt(document.getElementById(`${prefix}_circuit_${i}_points`)?.value) || 0;

                if(pointsInCircuit <= 0) continue;
                let interDist = 0;
                for (let j = 1; j < pointsInCircuit; j++) {
                    interDist += parseFloat(document.getElementById(`${prefix}-${i}_inter_dist_${j}`)?.value) || 0;
                }
                const totalWiringDist = panelDist + interDist;
                const isSocket = prefix === 'socket';

                if (installType === 'surface_vaf' && isSocket) {
                    addQty('1.3', totalWiringDist);
                    addQty('3.1', pointsInCircuit);
                } 
                else if (installType.includes('_pvc') && installType !== 'surface_pvc_trunking') {
                    addQty(isSocket ? '1.1' : '1.2', totalWiringDist);
                    if (installType.includes('concealed')) {
                        addQty('2.3', totalWiringDist);
                    } else {
                        addQty('2.1', totalWiringDist);
                    }
                    const pointTaskId = isSocket ? (installType.includes('concealed') ? '3.2' : '3.1') : '3.3';
                    addQty(pointTaskId, pointsInCircuit);
                } else if (installType.includes('_emt')) {
                    addQty(isSocket ? '1.1' : '1.2', totalWiringDist);
                    addQty('2.2', totalWiringDist);
                    const pointTaskId = isSocket ? '3.1' : '3.3';
                    addQty(pointTaskId, pointsInCircuit);
                }
                
                if (!installType.includes('vaf')) {
                     addQty(installType.includes('_emt') ? '13.2' : '13.1', pointsInCircuit * 2);
                }

                if (!isSocket) {
                    const fixtureType = document.getElementById('fixture_type_1').value;
                    if (fixtureType === 'LED_E27') addQty('4.1', pointsInCircuit);
                    else if (fixtureType === 'LED_PANEL') addQty('15.1', pointsInCircuit);
                    else if (fixtureType === 'T8_SET') addQty('15.2', pointsInCircuit);
                }
            }
        });

        ['ac_wiring', 'heater_wiring'].forEach(prefix => {
            const unitCount = parseInt(document.getElementById(`${prefix}_units`)?.value) || 0;
            if (unitCount === 0) return;
            
            const installType = document.getElementById(prefix === 'ac_wiring' ? 'ac_install_type_4' : 'wh_install_type_5').value;

            for (let i = 1; i <= unitCount; i++) {
                const panelToBreakerDist = parseFloat(document.getElementById(`${prefix}_${i}_panel_to_breaker_dist`)?.value) || 0;
                const breakerToUnitDist = parseFloat(document.getElementById(`${prefix}_${i}_breaker_to_unit_dist`)?.value) || 0;
                const groundDist = parseFloat(document.getElementById(`${prefix}_${i}_panel_to_unit_dist_ground`)?.value) || 0;
                const breakerEl = document.getElementById(`${prefix}_${i}_breaker`);
                const breakerAmps = parseInt(breakerEl?.dataset.breakerAmps) || 0;

                if (breakerAmps === 0) continue;
                
                const totalConduitDist = panelToBreakerDist + breakerToUnitDist;
                
                if (installType.includes('_pvc') && installType !== 'surface_pvc_trunking') {
                    addQty(installType.includes('concealed') ? '2.3' : '2.1', totalConduitDist);
                    addQty('13.1', 2); 
                } else if (installType.includes('_emt')) {
                    addQty('2.2', totalConduitDist);
                    addQty('13.2', 2);
                }
                else if (installType === 'surface_pvc_trunking') {
                    addQty('14.1', totalConduitDist);
                }

                addQty('1.4', totalConduitDist);
                addQty('1.5', groundDist);
                addQty('12.1', 1);

                if (breakerAmps <= 16) addQty('10.1', 1);
                else if (breakerAmps <= 20) addQty('10.2', 1);
                else if (breakerAmps <= 32) addQty('10.3', 1);
            }
        });
        
        // Other simple inputs
        addQty('7.1', parseInt(document.getElementById('heater_units').value) || 0);
        addQty('5.1', parseInt(document.getElementById('ac_units').value) || 0);
        addQty('5.3', parseInt(document.getElementById('pump_units').value) || 0);
        addQty('5.4', parseInt(document.getElementById('fan_units').value) || 0);
        
        const lanPoints = parseInt(document.getElementById('lan_points').value) || 0;
        if (lanPoints > 0) { addQty('11.1', lanPoints); addQty('11.2', parseFloat(document.getElementById('lan_distance').value) || 0); }
        
        const tvPoints = parseInt(document.getElementById('tv_points').value) || 0;
        if(tvPoints > 0) { addQty('11.3', tvPoints); addQty('11.4', parseFloat(document.getElementById('tv_distance').value) || 0); }
        
        addQty('11.5', parseInt(document.getElementById('cctv_points').value) || 0);

        const cuSize = document.getElementById('cu_replacement').value;
        if (cuSize !== 'none') {
            const taskId = { '4_slot': '9.1', '6_slot': '9.2', '8_slot': '9.3', '10_slot': '9.4', '12_slot': '9.5' }[cuSize];
            addQty(taskId, 1);
        }
        if (document.getElementById('install_ground').checked) addQty('6.1', 1);
        
        addQty('10.1', parseInt(document.getElementById('mcb_16a').value) || 0);
        addQty('10.2', parseInt(document.getElementById('mcb_20a').value) || 0);
        addQty('10.3', parseInt(document.getElementById('mcb_32a').value) || 0);
        
        if (document.getElementById('service_inspection').checked) addQty('8.1', 1);
        if (document.getElementById('service_leak_find').checked) addQty('8.2', 1);
        if (document.getElementById('service_trip_find').checked) addQty('8.3', 1);
        addQty('8.4', parseInt(document.getElementById('service_lamp_replace').value) || 0);
        
        // Main Power
        const poleHeight = document.getElementById('pole_height_7').value;
        const totalPoles = parseInt(document.getElementById('pole_count_7').value) || 0;
        if (totalPoles > 0 && poleHeight !== '0') {
            if (poleHeight === '6.0') addQty('17.1', totalPoles);
            else if (poleHeight === '7.0') addQty('17.1-B', totalPoles);
            else if (poleHeight === '8.0') addQty('17.2', totalPoles);
            else if (poleHeight === '9.0') addQty('17.3', totalPoles);
        }
        addQty('17.4-2', parseInt(document.getElementById('rack_2_sets_7').value) || 0);
        addQty('17.4-4', parseInt(document.getElementById('rack_4_sets_7').value) || 0);
        
        const mainExtDist = parseFloat(document.getElementById('main_ext_dist_7').value) || 0;
        if (mainExtDist > 0) addQty('17.5', mainExtDist);

        const evToggle = document.getElementById('toggle_ev_charger_visibility').checked;
        if (evToggle) {
             const evDist = parseFloat(document.getElementById('ev_cable_dist_8').value) || 0;
             if(evDist > 0) {
                 addQty('18.1', 1);
                 if (document.getElementById('ev_install_type_8').value === 'new_meter_tou') addQty('18.2', 1);
                 
                 const cost = parseFloat(document.getElementById('ev_charger_cost_8').value) || 0;
                 if(priceList && cost > 0) priceList['M-EV-CHARGER-7KW'] = cost;
             }
        }
        
        addQty('19.1', parseInt(document.getElementById('demo_lights_9').value) || 0);
        addQty('19.2', parseInt(document.getElementById('demo_outlets_9').value) || 0);
        addQty('19.3', parseInt(document.getElementById('demo_cables_9').value) || 0);
        addQty('19.4', parseInt(document.getElementById('demo_ac_9').value) || 0);
        if (document.getElementById('demo_include_repair_9').checked) {
            const totalRepairPoints = (parseInt(document.getElementById('demo_lights_9').value) || 0) + (parseInt(document.getElementById('demo_outlets_9').value) || 0);
            addQty('19.5', totalRepairPoints);
        }

        return quantities;
    }

    function calculateCosts() {
        if (!appData || !priceList) return { totalWithVat: 0, labor: [], material: [], combined: [], purchaseOrder: {} };

        const results = { labor: [], material: [], combined: [], purchaseOrder: {} };
        let totalMaterialCost = 0;
        let totalLaborCost = 0;
        
        const taskQuantities = buildTaskQuantitiesFromConfig();
        const qualityMultiplier = parseFloat(document.getElementById('material_quality').value) || 1.0;
        
        for (const [taskId, quantity] of taskQuantities.entries()) {
            const task = allTasks.get(taskId);
            if (!task || quantity <= 0) continue;

            const isHiddenTask = taskId.startsWith('13.'); // Hide fittings
            let taskTotalMaterial = 0;
            
            task.material_components?.forEach(mat => {
                if (mat.material_id === 'M-WH-HOSE-FLEX' && document.getElementById('heater_exclude_hoses').checked) return;

                // Logic ‡∏™‡∏≤‡∏¢‡πÄ‡∏°‡∏ô
                if (taskId === '17.5') {
                    const meterSize = document.getElementById('meter_size_3').value;
                    const mainType = document.getElementById('main_ext_type_7').value;
                    const authority = document.getElementById('main_authority_7').value;
                    let cableSize = 0;
                    try { cableSize = appData.mainCableSpecs_v5_1[authority][meterSize][mainType]; } catch(e){}
                    
                    if (cableSize > 0) {
                         const cableMatId = `M-CABLE-${mainType}-${cableSize}`;
                         if (mat.material_id === cableMatId) {
                             const price = (priceList[mat.material_id] || 0) * qualityMultiplier;
                             const qty = Math.ceil(quantity);
                             taskTotalMaterial += (price * qty * 2); // L, N
                             
                             // Gnd
                             const gndId = 'M-WIRE-GND-10SQMM';
                             const gndPrice = (priceList[gndId] || 0) * qualityMultiplier;
                             taskTotalMaterial += (gndPrice * qty);
                             
                             if(!results.purchaseOrder[cableMatId]) results.purchaseOrder[cableMatId] = {description: `‡∏™‡∏≤‡∏¢‡πÄ‡∏°‡∏ô ${mainType} ${cableSize}`, spec: mat.spec, unit:'‡πÄ‡∏°‡∏ï‡∏£', quantity:0, unit_price: price};
                             results.purchaseOrder[cableMatId].quantity += (qty*2);
                             
                             if(!results.purchaseOrder[gndId]) results.purchaseOrder[gndId] = {description: `‡∏™‡∏≤‡∏¢‡∏î‡∏¥‡∏ô‡πÄ‡∏°‡∏ô`, spec: 'THW 10', unit:'‡πÄ‡∏°‡∏ï‡∏£', quantity:0, unit_price: gndPrice};
                             results.purchaseOrder[gndId].quantity += qty;
                         }
                    }
                } else {
                    // Normal logic
                    const price = (priceList[mat.material_id] || 0) * qualityMultiplier;
                    const qty = getMaterialQuantity(mat, quantity);
                    taskTotalMaterial += price * qty;
                    
                    if(!results.purchaseOrder[mat.material_id]) results.purchaseOrder[mat.material_id] = {description: allItems.get(mat.material_id)?.desc || mat.material_id, spec: mat.spec, unit:'‡∏´‡∏ô‡πà‡∏ß‡∏¢', quantity:0, unit_price: price};
                    results.purchaseOrder[mat.material_id].quantity += qty;
                }
            });
            
            let taskTotalLabor = 0;
            task.labor_components?.forEach(lab => taskTotalLabor += (priceList[lab.labor_id] || 0) * quantity);
            
            // Gnd Rod Wiring
            const groundDist = parseFloat(document.getElementById('ground_distance').value) || 0;
            if (taskId === '6.1' && groundDist > 0) {
                const wId = 'M-WIRE-GND-10SQMM';
                const wPrice = (priceList[wId] || 0) * qualityMultiplier;
                taskTotalMaterial += wPrice * groundDist;
                 if(!results.purchaseOrder[wId]) results.purchaseOrder[wId] = {description: `‡∏™‡∏≤‡∏¢‡∏î‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏î‡∏¥‡∏ô`, spec: 'THW 10', unit:'‡πÄ‡∏°‡∏ï‡∏£', quantity:0, unit_price: wPrice};
                 results.purchaseOrder[wId].quantity += groundDist;
            }
            
            totalMaterialCost += taskTotalMaterial;
            totalLaborCost += taskTotalLabor;
            
            if (!isHiddenTask) {
                const item = {
                    id: taskId, description: task.task_name, quantity: quantity, unit: task.unit_of_measure,
                    material_unit_cost: quantity>0 ? taskTotalMaterial/quantity : 0,
                    labor_unit_cost: quantity>0 ? taskTotalLabor/quantity : 0
                };
                results.combined.push(item);
                results.labor.push({...item, unit_price: item.labor_unit_cost, total_price: taskTotalLabor});
                results.material.push({...item, unit_price: item.material_unit_cost, total_price: taskTotalMaterial});
            }
        }

        // Manual Items
        manualBOQItems.forEach(item => {
            const matCost = item.material_unit_cost * item.quantity;
            const laborCost = item.labor_unit_cost * item.quantity;
            totalMaterialCost += matCost;
            totalLaborCost += laborCost;
            results.combined.push({ description: item.description, quantity: item.quantity, unit: item.unit, material_unit_cost: item.material_unit_cost, labor_unit_cost: item.labor_unit_cost });
        });
        manualPOItems.forEach(item => {
             results.purchaseOrder[item.id] = item;
        });
        
        // Multipliers
        const province = document.getElementById('province_selector').value;
        let mult = { labor: 1.0, material: 1.0 };
        if(appData.provinceMultipliers) {
             if(province === '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£') {
                  const zone = document.getElementById('bkk_zone_selector').value;
                  mult = appData.bkkZoneMultipliers[zone] || mult;
             } else {
                  mult = appData.provinceMultipliers[province] || appData.provinceMultipliers['default'];
             }
        }
        totalLaborCost *= mult.labor;
        totalMaterialCost *= mult.material;
        
        // Factors
        const overhead = parseFloat(document.getElementById('overhead_factor').value) || 0;
        const profit = parseFloat(document.getElementById('profit_factor').value) || 0;
        const wastage = parseFloat(document.getElementById('wastage_factor').value) || 0;
        
        totalMaterialCost *= (1 + wastage/100);
        let grand = totalMaterialCost + totalLaborCost;
        
        results.overheadAmount = grand * (overhead/100);
        grand += results.overheadAmount;
        results.profitAmount = grand * (profit/100);
        grand += results.profitAmount;
        
        const minCharge = parseFloat(document.getElementById('min_charge').value) || 0;
        if(grand < minCharge) { results.minChargeAdjustment = minCharge - grand; grand = minCharge; }
        else results.minChargeAdjustment = 0;
        
        if (document.getElementById('include_vat').checked) {
            results.vatAmount = grand * 0.07;
            grand += results.vatAmount;
        } else results.vatAmount = 0;
        
        results.totalMaterialCost = totalMaterialCost;
        results.totalLaborCost = totalLaborCost;
        results.totalWithVat = grand;
        results.grandTotal = grand - results.vatAmount; // Before VAT

        return results;
    }
    
    function updateRealtimeTotal() {
        const costs = calculateCosts();
        document.getElementById('total-display').textContent = `‡∏ø${formatCurrency(costs.totalWithVat)}`;
        updateMainCableSpecDisplay();
    }
    
    function getProjectInfoHeader() {
        const proj = document.getElementById('project_name').value || '-';
        const cust = document.getElementById('customer_name').value || '-';
        const date = document.getElementById('report_date').value;
        return `<div class="mb-4 border-b pb-4"><h2 class="text-2xl font-bold text-blue-600">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2><div class="text-right text-sm"><p><b>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</b> ${proj}</p><p><b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${cust}</p><p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${date}</p></div></div>`;
    }
    
    // --- Reporting ---
    function generateReport(costs, type) {
        // Simple report generation logic
        if(type === 'purchase-order') return generatePurchaseOrder(costs);
        if(type === 'boq-labor') return generateLaborBoq(costs);
        if(type === 'boq-material') return generateMaterialBoq(costs);
        return generateCombinedBoq(costs);
    }
    
    // (Reuse functions from V6 logic)
    function generateCombinedBoq(costs) {
        let html = `<h3 class="font-bold mb-2">BOQ ‡∏£‡∏ß‡∏°</h3><table class="w-full text-sm border-collapse"><tr class="bg-gray-100"><th class="p-2 border text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-2 border text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 border text-right">‡∏ß‡∏±‡∏™‡∏î‡∏∏</th><th class="p-2 border text-right">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</th><th class="p-2 border text-right">‡∏£‡∏ß‡∏°</th></tr>`;
        costs.combined.forEach(item => {
             html += `<tr><td class="p-2 border">${item.description}</td><td class="p-2 border text-center">${item.quantity} ${item.unit}</td><td class="p-2 border text-right">${formatCurrency(item.material_unit_cost)}</td><td class="p-2 border text-right">${formatCurrency(item.labor_unit_cost)}</td><td class="p-2 border text-right">${formatCurrency((item.material_unit_cost+item.labor_unit_cost)*item.quantity)}</td></tr>`;
        });
        html += `<tfoot><tr><td colspan="4" class="p-2 border text-right font-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td><td class="p-2 border text-right font-bold">${formatCurrency(costs.totalWithVat)}</td></tr></tfoot></table>`;
        return { html, title: 'BOQ Combined' };
    }
    
    function generateLaborBoq(costs) { return { html: '<h3>BOQ ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</h3><p>(‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô BOQ ‡∏£‡∏ß‡∏°‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏≠‡∏Å)</p>', title: 'Labor BOQ'}; } // Placeholder for brevity
    function generateMaterialBoq(costs) { return { html: '<h3>BOQ ‡∏ß‡∏±‡∏™‡∏î‡∏∏</h3><p>(‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô BOQ ‡∏£‡∏ß‡∏°‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏≠‡∏≠‡∏Å)</p>', title: 'Material BOQ'}; } // Placeholder for brevity
    function generatePurchaseOrder(costs) {
        let html = `<h3 class="font-bold mb-2">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3><table class="w-full text-sm border-collapse"><tr class="bg-gray-100"><th class="p-2 border text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-2 border text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 border text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="p-2 border text-right">‡∏£‡∏ß‡∏°</th></tr>`;
        Object.values(costs.purchaseOrder).forEach(item => {
             if(item.quantity > 0) html += `<tr><td class="p-2 border">${item.description} <small class="text-gray-500">${item.spec}</small></td><td class="p-2 border text-center">${item.quantity} ${item.unit}</td><td class="p-2 border text-right">${formatCurrency(item.unit_price)}</td><td class="p-2 border text-right">${formatCurrency(item.unit_price*item.quantity)}</td></tr>`;
        });
        html += `</table>`;
        return { html, title: 'Purchase Order' };
    }
    
    function displayReport() {
        const costs = calculateCosts();
        const activeTab = document.querySelector('.tab-active').dataset.tab;
        const reportData = generateReport(costs, activeTab);
        document.getElementById('report-content').innerHTML = reportData.html;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        
        // Bind Events
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', updateRealtimeTotal);
            input.addEventListener('input', updateRealtimeTotal);
        });
        
        // Special circuit inputs binding logic needs to be re-applied after rendering inputs
        // (Currently handled by inline onchange/input in render functions if fully implemented, 
        // but here we rely on global delegation or re-binding)
        document.body.addEventListener('input', (e) => {
             if(e.target.matches('.dist-part-input')) { /* ... logic ... */ updateRealtimeTotal(); }
             else if(e.target.matches('.point-count-input')) { /* ... handlePointCountChange ... */ }
        });

        document.getElementById('calculate-btn').addEventListener('click', () => {
            document.getElementById('output-section').classList.remove('hidden');
            document.getElementById('output-section').scrollIntoView({behavior: 'smooth'});
            displayReport();
        });
        
        document.getElementById('reset-btn').addEventListener('click', () => {
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) resetForm();
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active', 'border-b-2', 'border-blue-600', 'text-blue-600'));
                e.target.classList.add('tab-active', 'border-b-2', 'border-blue-600', 'text-blue-600');
                displayReport();
            });
        });
        
        // Accordion
        document.querySelectorAll('.collapsible-card h3').forEach(h=>{
            h.addEventListener('click', ()=>{
              h.parentElement.classList.toggle('open');
            });
        });
        
        // Manual Add
        document.getElementById('manual-job-add-btn').addEventListener('click', () => {
             const name = document.getElementById('manual-job-name').value;
             const price = parseFloat(document.getElementById('manual-job-labor-total').value) || 0;
             if(name) {
                 manualBOQItems.push({
                     id: Date.now(), description: name, quantity: 1, unit: '‡∏á‡∏≤‡∏ô',
                     labor_unit_cost: price, material_unit_cost: 0
                 });
                 alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
                 updateRealtimeTotal();
             }
        });
        
        // Manual Add Material Row (Visual only for now in this simplified version)
        document.getElementById('manual-job-add-material-row').addEventListener('click', () => {
             const tbody = document.querySelector('#manual-job-materials-table tbody');
             tbody.innerHTML += `<tr><td><input class="form-input p-1 manual-mat-desc"></td><td><input type="number" class="form-input p-1 manual-mat-qty"></td><td><input class="form-input p-1 manual-mat-unit"></td><td><input type="number" class="form-input p-1 manual-mat-price"></td><td><button class="btn-delete-row" onclick="this.closest('tr').remove()">x</button></td></tr>`;
        });
        
        // Dynamic Circuit Renderers (Re-implementing the listeners)
        const circuitTriggers = {
            'socket_circuits': ['socket', document.getElementById('socket_circuits_container')],
            'light_circuits': ['light', document.getElementById('light_circuits_container')],
            'ac_wiring_units': ['ac_wiring', document.getElementById('ac_wiring_circuits_container')],
            'heater_wiring_units': ['heater_wiring', document.getElementById('heater_wiring_circuits_container')]
        };
        
        Object.keys(circuitTriggers).forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const [prefix, container] = circuitTriggers[id];
                const count = parseInt(e.target.value) || 0;
                if (prefix.includes('wiring')) renderDedicatedCircuitInputs(prefix, count, container);
                else renderCircuitInputs(prefix, count, container);
            });
        });
    });

</script>
</body>
</html>
